<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal del Actuario - Gestión de Causas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Colores de estado */
        .estado-pendiente { background-color: #fef9c3; color: #a16207; }
        .estado-asignada { background-color: #dbeafe; color: #1e40af; }
        .estado-en_revisión, .estado-en_revision { background-color: #fee2e2; color: #991b1b; }
        .estado-archivada, .estado-cerrada { background-color: #f3f4f6; color: #374151; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Función auxiliar para formatear fecha ---
        const formatearFecha = (fechaISO) => {
            if(!fechaISO) return "Sin fecha";
            const fecha = new Date(fechaISO);
            return fecha.toLocaleDateString('es-CL', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        };

        // --- Componente: Tarjeta de Causa Individual ---
        const CausaCard = ({ causa, estadosPosibles, onEstadoActualizado, actuarioId }) => {
            const [nuevoEstado, setNuevoEstado] = useState(causa.estado_id);
            const [isUpdating, setIsUpdating] = useState(false);
            const [updateMessage, setUpdateMessage] = useState(null);
            
            // Estados para subida de archivo
            const [archivoSeleccionado, setArchivoSeleccionado] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [uploadMessage, setUploadMessage] = useState(null);

            // Clase CSS dinámica según el estado
            const getEstadoClass = (estado) => {
                const normalized = estado ? estado.toLowerCase().replace(' ', '_') : '';
                return `estado-${normalized}` || 'bg-gray-200 text-gray-800';
            };
            
            useEffect(() => {
                setNuevoEstado(causa.estado_id);
                setUpdateMessage(null);
                setUploadMessage(null);
                setArchivoSeleccionado(null);
            }, [causa]);

            // --- ACTUALIZAR ESTADO (Conectado a PHP) ---
            const handleUpdate = async () => {
                setIsUpdating(true);
                setUpdateMessage(null);
                try {
                    const response = await fetch('api/actualizar_estado_causa.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            causa_id: causa.causa_id,
                            nuevo_estado_id: nuevoEstado,
                            actuario_id: actuarioId 
                        })
                    });
                    const result = await response.json();
                    
                    if (!response.ok) throw new Error(result.message || 'Error al actualizar');
                    
                    setUpdateMessage({ type: 'success', text: result.message || 'Estado actualizado.' });
                    
                    // Recargar la lista principal para que se vea el cambio
                    if(onEstadoActualizado) onEstadoActualizado(); 

                } catch (err) {
                    setUpdateMessage({ type: 'error', text: err.message || 'Error de conexión' });
                } finally {
                    setIsUpdating(false);
                }
            };

            // --- SUBIR ARCHIVO (REAL) ---
            const handleFileUpload = async () => {
                if (!archivoSeleccionado) return;
                
                setIsUploading(true);
                setUploadMessage(null);

                try {
                    // 1. Crear FormData
                    const formData = new FormData();
                    formData.append('archivo', archivoSeleccionado);
                    formData.append('causa_id', causa.causa_id);

                    // 2. Fetch al backend REAL
                    const response = await fetch('api/subir_archivo_actuario.php', { 
                        method: 'POST', 
                        body: formData 
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.message || 'Error al subir el archivo');
                    }

                    // 3. Éxito
                    setUploadMessage({ type: 'success', text: `Documento subido correctamente.` });
                    setArchivoSeleccionado(null);
                    
                    // 4. Actualizar la lista principal
                    if(onEstadoActualizado) onEstadoActualizado(); 

                } catch (err) {
                    console.error(err);
                    setUploadMessage({ type: 'error', text: 'Error: ' + err.message });
                } finally {
                    setIsUploading(false);
                }
            };

            return (
                <div className="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 transition-all hover:shadow-lg mb-6">
                    {/* Encabezado de la Tarjeta */}
                    <div className="p-5 border-b border-gray-200 flex flex-col md:flex-row justify-between md:items-center gap-4 bg-gray-50">
                        <div>
                            <div className="flex items-center gap-3">
                                <h2 className="text-xl font-bold text-gray-800">{causa.numero_causa}</h2>
                                <span className={`px-3 py-1 text-xs font-bold rounded-full uppercase tracking-wide ${getEstadoClass(causa.nombre_estado)}`}>
                                    {causa.nombre_estado}
                                </span>
                            </div>
                            <p className="text-sm text-gray-500 mt-1">
                                {causa.tipo_procedimiento} {causa.tipo_reclamo ? `(${causa.tipo_reclamo})` : ''} &bull; {causa.nombre_juzgado}
                            </p>
                        </div>
                        <div className="text-sm text-gray-500">
                            <i className="far fa-calendar-alt mr-1"></i> {formatearFecha(causa.fecha_recepcion)}
                        </div>
                    </div>

                    <div className="p-5 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {/* Columna Izquierda: Documentos y Datos */}
                        <div className="space-y-4">
                            <div>
                                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Expediente Digital</h3>
                                {causa.archivos && causa.archivos.length > 0 ? (
                                    <ul className="space-y-2">
                                        {causa.archivos.map((archivo, index) => (
                                            <li key={index} className="flex items-center justify-between p-2 bg-white rounded border border-gray-200 hover:bg-blue-50 transition">
                                                <div className="flex items-center overflow-hidden">
                                                    {/* Lógica de icono según tipo */}
                                                    <i className={`far ${archivo.tipo === 'principal' ? 'fa-file-pdf text-red-600' : 'fa-file-alt text-blue-600'} mr-3 text-lg`}></i>
                                                    <span className="text-sm text-gray-700 truncate font-medium" title={archivo.nombre_archivo}>
                                                        {archivo.nombre_archivo}
                                                    </span>
                                                </div>
                                                <a href={archivo.ruta_archivo} download className="text-blue-600 hover:text-blue-800 text-xs font-bold px-2 py-1 rounded hover:bg-blue-100">
                                                    <i className="fas fa-download mr-1"></i> Descargar
                                                </a>
                                            </li>
                                        ))}
                                    </ul>
                                ) : (
                                    <div className="text-sm text-gray-400 italic p-3 border border-dashed rounded text-center">
                                        No hay documentos adjuntos.
                                    </div>
                                )}
                            </div>
                            
                            {/* Participantes */}
                            <div>
                                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Implicados</h3>
                                <ul className="text-sm space-y-1">
                                    {causa.participantes.map((p, idx) => (
                                        <li key={idx} className="text-gray-600">
                                            <span className="font-semibold text-gray-800">{p.nombre_rol}:</span> {p.nombre_completo}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>

                        {/* Columna Derecha: Acciones */}
                        <div className="space-y-6">
                            
                            {/* 1. Cambiar Estado */}
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                <h3 className="text-sm font-bold text-blue-800 mb-2 flex items-center">
                                    <i className="fas fa-tasks mr-2"></i> Actualizar Estado
                                </h3>
                                <div className="flex gap-2">
                                    <select
                                        value={nuevoEstado}
                                        onChange={(e) => setNuevoEstado(e.target.value)}
                                        className="flex-1 text-sm border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                    >
                                        {estadosPosibles.map(est => (
                                            <option key={est.estado_id} value={est.estado_id}>{est.nombre_estado}</option>
                                        ))}
                                    </select>
                                    <button
                                        onClick={handleUpdate}
                                        disabled={isUpdating || nuevoEstado == causa.estado_id}
                                        className={`px-4 py-1.5 rounded text-sm font-medium text-white transition shadow-sm
                                            ${isUpdating || nuevoEstado == causa.estado_id ? 'bg-blue-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                                    >
                                        {isUpdating ? <i className="fas fa-spinner fa-spin"></i> : 'Guardar'}
                                    </button>
                                </div>
                                {updateMessage && (
                                    <p className={`text-xs mt-2 font-medium ${updateMessage.type === 'error' ? 'text-red-600' : 'text-green-600'}`}>
                                        <i className={`fas ${updateMessage.type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-1`}></i>
                                        {updateMessage.text}
                                    </p>
                                )}
                            </div>

                            {/* 2. Subir Nuevo Escrito */}
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 className="text-sm font-bold text-gray-700 mb-2 flex items-center">
                                    <i className="fas fa-upload mr-2"></i> Adjuntar Resolución
                                </h3>
                                <div className="flex flex-col gap-3">
                                    <input 
                                        type="file" 
                                        onChange={(e) => setArchivoSeleccionado(e.target.files[0])}
                                        accept="application/pdf"
                                        className="text-xs text-gray-500 file:mr-2 file:py-2 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300 cursor-pointer"
                                    />
                                    <button
                                        onClick={handleFileUpload}
                                        disabled={!archivoSeleccionado || isUploading}
                                        className={`w-full py-2 rounded text-sm font-medium border transition shadow-sm
                                            ${!archivoSeleccionado || isUploading 
                                                ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' 
                                                : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50 hover:text-blue-600'}`}
                                    >
                                        {isUploading ? <span><i className="fas fa-circle-notch fa-spin mr-1"></i> Subiendo...</span> : 'Subir Documento'}
                                    </button>
                                </div>
                                {uploadMessage && (
                                    <p className={`text-xs mt-2 font-medium ${uploadMessage.type === 'error' ? 'text-red-600' : 'text-green-600'}`}>
                                        {uploadMessage.text}
                                    </p>
                                )}
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        // --- Componente Principal ---
        const App = () => {
            const [view, setView] = useState('login');
            const [rut, setRut] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState(null);
            
            // Datos del Actuario y Causas
            const [actuarioData, setActuarioData] = useState({ 
                actuario_id: null,
                nombre_actuario: '',
                causas_asignadas: [], 
                estados_posibles: [] 
            });
            
            // Filtros y Paginación
            const [searchTerm, setSearchTerm] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 5;

            // --- CONEXIÓN A LA BASE DE DATOS ---
            const fetchCausas = async (showLoading = true) => {
                if (showLoading) setView('loading');
                setError(null);
                try {
                    // LLAMADA AL BACKEND REAL
                    const response = await fetch(`api/consultar_causas_actuario.php?rut=${rut}`);
                    const data = await response.json();
                    
                    if (!response.ok) throw new Error(data.message || 'Error al conectar');
                    
                    setActuarioData(data);
                    setView('results');
                } catch (err) {
                    console.error("Error fetching data:", err);
                    setError(err.message || "Error desconocido");
                    setView('login');
                }
            };

            const handleLogin = (e) => {
                e.preventDefault();
                setError(null);
                if (!rut) {
                    setError('Ingrese su RUT');
                    return;
                }
                fetchCausas(true);
            };

            const handleLogout = () => {
                setRut('');
                setPassword('');
                setSearchTerm('');
                setCurrentPage(1);
                setActuarioData({ actuario_id: null, nombre_actuario: '', causas_asignadas: [], estados_posibles: [] });
                setView('login');
            };

            // Lógica de Paginación
            const filteredCausas = actuarioData.causas_asignadas.filter(causa => 
                causa.numero_causa && causa.numero_causa.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = filteredCausas.slice(indexOfFirstItem, indexOfLastItem);
            const totalPages = Math.ceil(filteredCausas.length / itemsPerPage);

            const paginate = (pageNumber) => setCurrentPage(pageNumber);

            useEffect(() => {
                setCurrentPage(1);
            }, [searchTerm]);

            // --- RENDERIZADO ---
            if (view === 'loading') {
                return (
                    <div className="flex h-screen items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <i className="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                            <h2 className="text-xl font-medium text-gray-700">Cargando Causas...</h2>
                        </div>
                    </div>
                );
            }

            if (view === 'results') {
                return (
                    <div className="max-w-6xl mx-auto p-4 md:p-8">
                        {/* Header */}
                        <div className="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">Panel de Gestión</h1>
                                <p className="text-gray-500 text-sm mt-1">
                                    <i className="fas fa-user-tie mr-1"></i> {actuarioData.nombre_actuario}
                                </p>
                            </div>
                            <button onClick={handleLogout} className="mt-4 md:mt-0 px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded font-medium transition">
                                <i className="fas fa-sign-out-alt mr-1"></i> Cerrar Sesión
                            </button>
                        </div>

                        {/* Buscador */}
                        <div className="bg-white p-5 rounded-lg shadow-sm mb-6 flex flex-col md:flex-row items-center gap-4 border border-gray-200">
                            <div className="flex-1 relative w-full">
                                <i className="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                                <input 
                                    type="text"
                                    placeholder="Buscar por ROL (Ej: CAUSA-000004)..."
                                    className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <div className="text-sm text-gray-600 font-medium whitespace-nowrap">
                                <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded">{filteredCausas.length}</span> causas
                            </div>
                        </div>
                        
                        {/* Lista */}
                        <div className="space-y-6">
                            {currentItems.length > 0 ? (
                                currentItems.map((causa) => (
                                    <CausaCard 
                                        key={causa.causa_id} 
                                        causa={causa} 
                                        estadosPosibles={actuarioData.estados_posibles}
                                        onEstadoActualizado={() => fetchCausas(false)} 
                                        actuarioId={actuarioData.actuario_id}
                                    />
                                ))
                            ) : (
                                <div className="text-center py-16 bg-white rounded-lg border-2 border-dashed border-gray-300">
                                    <i className="fas fa-folder-open text-gray-300 text-5xl mb-4"></i>
                                    <p className="text-gray-500 text-lg">
                                        {searchTerm ? `No se encontraron causas para "${searchTerm}"` : "No tiene causas asignadas."}
                                    </p>
                                </div>
                            )}
                        </div>

                        {/* Paginación */}
                        {totalPages > 1 && (
                            <div className="flex justify-center items-center mt-10 gap-3">
                                <button onClick={() => paginate(currentPage - 1)} disabled={currentPage === 1} className={`px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm ${currentPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-300'}`}>
                                    <i className="fas fa-chevron-left mr-1"></i> Anterior
                                </button>
                                <span className="px-4 py-2 text-sm text-gray-600 font-medium bg-white rounded border border-gray-200">
                                    Página {currentPage} de {totalPages}
                                </span>
                                <button onClick={() => paginate(currentPage + 1)} disabled={currentPage === totalPages} className={`px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm ${currentPage === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-300'}`}>
                                    Siguiente <i className="fas fa-chevron-right ml-1"></i>
                                </button>
                            </div>
                        )}
                    </div>
                );
            }

            // Vista Login
            return (
                <div className="flex justify-center items-center min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 p-4">
                    <div className="bg-white p-8 md:p-10 rounded-2xl shadow-xl w-full max-w-md border border-gray-100">
                        <div className="text-center mb-8">
                            <div className="inline-block p-3 bg-blue-50 rounded-full mb-4">
                                <i className="fas fa-balance-scale text-3xl text-blue-600"></i>
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800">Poder Judicial</h1>
                            <p className="text-gray-500 mt-2 text-sm">Acceso Privado para Funcionarios</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-5">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1.5 ml-1">RUT Funcionario</label>
                                <div className="relative">
                                    <i className="fas fa-user absolute left-3 top-3.5 text-gray-400"></i>
                                    <input type="text" value={rut} onChange={(e) => setRut(e.target.value)} className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="12.345.678-9" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-1.5 ml-1">Clave Única</label>
                                <div className="relative">
                                    <i className="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i>
                                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="••••••••" />
                                </div>
                            </div>
                            {error && <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg flex items-center"><i className="fas fa-exclamation-triangle mr-2"></i>{error}</div>}
                            <button className="w-full bg-blue-600 text-white py-3.5 rounded-lg font-bold hover:bg-blue-700 transition transform active:scale-[0.98] shadow-lg shadow-blue-500/30">Ingresar al Sistema</button>
                        </form>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>